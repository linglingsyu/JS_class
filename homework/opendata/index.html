<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>opendata</title>

  <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/v/bs4-4.1.1/dt-1.10.21/datatables.min.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.9.3/Chart.min.css">
  <script src="jquery-3.5.1.min.js"></script>
  <script type="text/javascript" src="https://cdn.datatables.net/v/bs4-4.1.1/dt-1.10.21/datatables.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.9.3/Chart.min.js"></script>
  <style>
  </style>
</head>

<body class="px-5 mx-5 my-1 d-flex">
  <div class="container w-50">
    <h1 class="text-center mb-3">台灣地區細懸浮微粒資料(PM2.5)</h1>
    <table id="myTable" class="table">
      <thead>
        <th>城市</th>
        <th>地區</th>
        <th>PM2.5</th>
        <th>UpdateTime</th>
      </thead>
      <tbody>
      </tbody>
    </table>
  </div>
  <div class="w-50"><canvas id="myChart" width="3" height="2"></canvas></div>
</body>

<script>


  let data;
  $.getJSON("https://data.epa.gov.tw/api/v1/aqx_p_02?limit=1000&api_key=9be7b239-557b-4c10-9775-78cadfc555e9&format=json").done(function (res) {
    data = res.records;

    let county = new Array();
    //  console.log(res);
    for (let i = 0; i < data.length; i++) {
      let str = `
        <tr>
          <td>${data[i].county}</td>
          <td>${data[i].Site}</td>
          <td>${data[i].PM25}</td>
          <td>${data[i].DataCreationDate}</td>
        </tr>
        `;
      $("tbody").append(str);
      county.push(data[i].county);
    }
    $('#myTable').DataTable();

    let pm25total = {};
    let pm25;
    for (let i =0; i <data.length ; i++){
      let tmp = data[i].county;
      if(data[i].PM25 == ""){
        pm25=0;
      }else{
        pm25 = parseInt(data[i].PM25);
      }
      if(pm25total.hasOwnProperty(tmp)){
         pm25total[tmp] += pm25 ; 
      }else{
          pm25total[tmp] = pm25 ; 
      }
    }
    let key = Object.keys(pm25total);
    let values =  Object.values(pm25total);
    let rgb = new Array();
    let str = "";
    for (let i= 1; i <= key.length ; i++){
      let r  = Math.floor(Math.random()*256) ,  g = Math.floor(Math.random()*256) ,  b  = Math.floor(Math.random()*256)
      str = `rgb(${r},${g},${b})`;
      rgb.push(str)
    }
    let copy = values.slice(0,values.length);
    // console.log( Math.max(copy));
    var ctx = document.getElementById('myChart').getContext('2d');
    var myChart = new Chart(ctx, {
      type: 'pie',
      data: {
        labels: key,
        datasets: [{
          label: '# of Votes',
          data: values,
          backgroundColor:rgb,
          borderColor: rgb,
          borderWidth: 1
        }]
      },
      options: {
        scales: {
          yAxes: [{
            ticks: {
              beginAtZero: false
            }
          }]
        }
      }
    });

  }).fail(
    function () {
      console.log("no");
    });
</script>


</html>